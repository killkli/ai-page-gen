import{r as c,j as e,u as We}from"./react-vendor-Bqsb6Ck2.js";import{H as Ee,I as Ge,J as de,K as Me,L,G as Oe}from"./app-services-B8Qj6iT_.js";import{t as se,a as te,b as ne}from"./gemini-service-DP3FNRyP.js";import{L as _e,M as Ve}from"./interactive-components-D01OhYVU.js";const Re=({content:d,apiKey:g,vocabularyLevel:v,isStudentMode:C=!1})=>{const[F,E]=c.useState("sentence"),[w,G]=c.useState({}),[Q,k]=c.useState({}),[T,f]=c.useState({}),M=c.useCallback((r,S)=>{G(N=>({...N,[r]:S}))},[]),x=c.useCallback(async(r,S)=>{if(!g){alert("需要 API Key 才能獲得 AI 批改回饋");return}const N=w[r.id];if(!N?.trim()){alert("請先完成您的作品再提交批改");return}f(p=>({...p,[r.id]:!0}));try{const p=await Ee(N,S,r,g,v);k(P=>({...P,[r.id]:p}))}catch(p){console.error("AI 批改失敗:",p),alert("AI 批改失敗，請檢查網路連線和 API Key 設定")}finally{f(p=>({...p,[r.id]:!1}))}},[g,w,v]),j=()=>e.jsx("div",{className:"space-y-6",children:d.sentencePractice.map((r,S)=>e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6 border border-blue-200",children:[e.jsx("div",{className:"flex items-start justify-between mb-4",children:e.jsxs("div",{children:[e.jsxs("h4",{className:"text-lg font-semibold text-gray-800 mb-2",children:["造句練習 ",S+1,e.jsx("span",{className:`ml-2 px-2 py-1 text-xs rounded-full ${r.difficulty==="easy"?"bg-green-100 text-green-700":r.difficulty==="normal"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:r.difficulty==="easy"?"簡單":r.difficulty==="normal"?"普通":"困難"})]}),e.jsx("p",{className:"text-gray-700 mb-3",children:r.instruction}),r.keywords.length>0&&e.jsxs("div",{className:"mb-3",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600 mb-1",children:"必須使用的關鍵詞："}),e.jsx("div",{className:"flex flex-wrap gap-2",children:r.keywords.map((N,p)=>e.jsx("span",{className:"bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm",children:N},p))})]}),r.exampleSentence&&e.jsxs("div",{className:"mb-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600 mb-1",children:"範例句子："}),e.jsx("p",{className:"text-gray-700 italic",children:r.exampleSentence})]}),r.hints&&r.hints.length>0&&e.jsxs("div",{className:"mb-3",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600 mb-1",children:"提示："}),e.jsx("ul",{className:"text-sm text-gray-600 space-y-1",children:r.hints.map((N,p)=>e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-500 mt-1",children:"•"}),N]},p))})]})]})}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"您的造句："}),e.jsx("textarea",{value:w[r.id]||"",onChange:N=>M(r.id,N.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",rows:3,placeholder:"請在此輸入您的造句..."}),e.jsxs("div",{className:"mt-3 flex justify-between items-center",children:[e.jsxs("span",{className:"text-sm text-gray-500",children:["字數: ",(w[r.id]||"").length]}),g&&e.jsx("button",{onClick:()=>x(r,"sentence"),disabled:!w[r.id]?.trim()||T[r.id],className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:T[r.id]?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"animate-spin",children:"⏳"}),"AI 批改中..."]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-4 h-4",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})}),"獲得 AI 批改"]})})]})]}),Q[r.id]&&e.jsx(me,{feedback:Q[r.id]})]},r.id))}),B=()=>e.jsx("div",{className:"space-y-6",children:d.writingPractice.map(r=>e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6 border border-purple-200",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("h4",{className:"text-lg font-semibold text-gray-800 mb-2",children:[r.title,e.jsx("span",{className:`ml-2 px-2 py-1 text-xs rounded-full ${r.difficulty==="easy"?"bg-green-100 text-green-700":r.difficulty==="normal"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:r.difficulty==="easy"?"簡單":r.difficulty==="normal"?"普通":"困難"})]}),e.jsx("p",{className:"text-gray-700 mb-3",children:r.instruction}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600 mb-2",children:"建議結構："}),e.jsx("ul",{className:"text-sm text-gray-600 space-y-1",children:r.structure.map((S,N)=>e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-purple-500 mt-1",children:"•"}),S]},N))})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium text-gray-600 mb-2",children:["字數要求: ",r.minLength," - ",r.maxLength," 字"]}),r.keywords&&r.keywords.length>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600 mb-1",children:"建議使用詞彙："}),e.jsx("div",{className:"flex flex-wrap gap-1",children:r.keywords.map((S,N)=>e.jsx("span",{className:"bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs",children:S},N))})]})]})]}),r.exampleOutline&&e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg mb-4",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600 mb-1",children:"範例大綱："}),e.jsx("p",{className:"text-gray-700 text-sm",children:r.exampleOutline})]})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"您的寫作："}),e.jsx("textarea",{value:w[r.id]||"",onChange:S=>M(r.id,S.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent",rows:8,placeholder:"請在此輸入您的文章..."}),e.jsxs("div",{className:"mt-3 flex justify-between items-center",children:[e.jsxs("div",{className:"text-sm text-gray-500",children:[e.jsxs("span",{children:["字數: ",(w[r.id]||"").length]}),e.jsx("span",{className:"ml-4",children:(w[r.id]||"").length<r.minLength?`還需 ${r.minLength-(w[r.id]||"").length} 字`:(w[r.id]||"").length>r.maxLength?`超出 ${(w[r.id]||"").length-r.maxLength} 字`:"符合字數要求"})]}),g&&e.jsx("button",{onClick:()=>x(r,"writing"),disabled:!w[r.id]?.trim()||T[r.id],className:"px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:T[r.id]?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"animate-spin",children:"⏳"}),"AI 批改中..."]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-4 h-4",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})}),"獲得 AI 批改"]})})]})]}),Q[r.id]&&e.jsx(me,{feedback:Q[r.id]})]},r.id))});return e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-purple-50 rounded-lg p-6 mt-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-8 h-8 text-blue-600",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-2xl font-bold text-gray-800",children:"寫作練習與 AI 批改"}),e.jsx("p",{className:"text-gray-600 text-sm",children:d.instructions})]})]}),!C&&e.jsxs("div",{className:"text-sm text-gray-500 bg-white px-3 py-2 rounded-lg border",children:[e.jsxs("div",{children:["造句練習: ",d.sentencePractice.length," 題"]}),e.jsxs("div",{children:["寫作練習: ",d.writingPractice.length," 題"]})]})]}),e.jsxs("div",{className:"flex border-b border-gray-200 mb-6",children:[e.jsxs("button",{onClick:()=>E("sentence"),className:`px-6 py-3 font-medium text-sm border-b-2 transition-colors ${F==="sentence"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700"}`,children:["提示造句 (",d.sentencePractice.length,")"]}),e.jsxs("button",{onClick:()=>E("writing"),className:`px-6 py-3 font-medium text-sm border-b-2 transition-colors ${F==="writing"?"border-purple-500 text-purple-600":"border-transparent text-gray-500 hover:text-gray-700"}`,children:["提示寫作 (",d.writingPractice.length,")"]})]}),F==="sentence"?j():B()]})},me=({feedback:d})=>e.jsxs("div",{className:"mt-4 border-t pt-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-4",children:[e.jsxs("h5",{className:"font-semibold text-gray-800 mb-3 flex items-center gap-2",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5 text-green-600",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.847a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.847.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z"})}),"AI 批改回饋",e.jsxs("div",{className:`ml-2 px-3 py-1 rounded-full text-sm font-bold ${d.score>=85?"bg-green-100 text-green-800":d.score>=70?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:[d.score," 分"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[d.strengths.length>0&&e.jsxs("div",{children:[e.jsx("h6",{className:"font-medium text-green-700 mb-2",children:"✅ 優點"}),e.jsx("ul",{className:"space-y-1",children:d.strengths.map((g,v)=>e.jsxs("li",{className:"text-sm text-gray-700 flex items-start gap-2",children:[e.jsx("span",{className:"text-green-500 mt-1",children:"•"}),g]},v))})]}),d.improvements.length>0&&e.jsxs("div",{children:[e.jsx("h6",{className:"font-medium text-orange-700 mb-2",children:"💡 改進建議"}),e.jsx("ul",{className:"space-y-1",children:d.improvements.map((g,v)=>e.jsxs("li",{className:"text-sm text-gray-700 flex items-start gap-2",children:[e.jsx("span",{className:"text-orange-500 mt-1",children:"•"}),g]},v))})]})]}),d.grammarCorrections&&d.grammarCorrections.length>0&&e.jsxs("div",{className:"mb-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200",children:[e.jsx("h6",{className:"font-medium text-yellow-800 mb-2",children:"📝 語法修正"}),d.grammarCorrections.map((g,v)=>e.jsxs("div",{className:"mb-2 last:mb-0",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-red-600 line-through",children:g.original}),e.jsx("span",{className:"mx-2",children:"→"}),e.jsx("span",{className:"text-green-600 font-medium",children:g.corrected})]}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:g.explanation})]},v))]}),d.vocabularyTips&&d.vocabularyTips.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("h6",{className:"font-medium text-blue-700 mb-2",children:"📚 詞彙建議"}),e.jsx("ul",{className:"space-y-1",children:d.vocabularyTips.map((g,v)=>e.jsxs("li",{className:"text-sm text-gray-700 flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-500 mt-1",children:"•"}),g]},v))})]}),d.structureFeedback&&e.jsxs("div",{className:"mb-4",children:[e.jsx("h6",{className:"font-medium text-purple-700 mb-2",children:"🏗️ 結構回饋"}),e.jsx("p",{className:"text-sm text-gray-700",children:d.structureFeedback})]}),e.jsxs("div",{className:"border-t pt-3",children:[e.jsx("h6",{className:"font-medium text-gray-800 mb-2",children:"📋 整體評語"}),e.jsx("p",{className:"text-sm text-gray-700 bg-white p-3 rounded-lg border",children:d.overallComment})]})]}),Ue=()=>{const[d]=We(),g=d.get("contentId"),v=d.get("binId"),[C,F]=c.useState(null),[E,w]=c.useState(!0),[G,Q]=c.useState(null),[k,T]=c.useState(0),[f,M]=c.useState([]),[x,j]=c.useState({}),[B,r]=c.useState("idle"),[S,N]=c.useState(""),[p,P]=c.useState("idle"),[O,_]=c.useState({current:0,total:0}),[z,V]=c.useState(new Set),[A,xe]=c.useState([]),[q,ae]=c.useState(null),[re,R]=c.useState(!1),[ie,le]=c.useState(""),[he,H]=c.useState(!1),[U,ue]=c.useState(""),[D,J]=c.useState({trueFalse:3,multipleChoice:3,memoryCardGame:1}),[ge,K]=c.useState(!1),[y,fe]=c.useState(null),[je,be]=c.useState(""),X=()=>g||v;c.useEffect(()=>{(async()=>{try{w(!0),Q(null);let t;if(v)t=await Ge(v);else if(g){await de.init();const a=await de.getLessonPlan(g);if(!a)throw new Error("找不到指定的教案");t={topic:a.topic,learningObjectives:a.content.learningObjectives,contentBreakdown:a.content.contentBreakdown,confusingPoints:a.content.confusingPoints,classroomActivities:a.content.classroomActivities,onlineInteractiveQuiz:a.content.quiz,writingPractice:a.content.writingPractice,transformedData:{}}}else throw new Error("缺少必要參數：contentId 或 binId");F(t),pe(t);const n=g||v;n&&await ee(n)}catch(t){console.error("載入內容失敗:",t),Q(t.message||"載入內容時發生錯誤")}finally{w(!1)}})()},[g,v]);const pe=s=>{const t=[],n={};s.learningObjectives&&s.learningObjectives.length>0&&s.learningObjectives.forEach((a,i)=>{const l=`step_${t.length}`;t.push({id:l,title:`學習目標 ${i+1}`,type:"objective",icon:"🎯",data:a,index:i}),n[l]={original:a,transformed:null,isTransformed:!1,isTransforming:!1,quiz:null,hasQuiz:!1,isGeneratingQuiz:!1}}),s.contentBreakdown&&s.contentBreakdown.length>0&&s.contentBreakdown.forEach((a,i)=>{const l=`step_${t.length}`;t.push({id:l,title:`深度學習 ${i+1}`,type:"breakdown",icon:"📖",data:a,index:i}),n[l]={original:a,transformed:null,isTransformed:!1,isTransforming:!1,quiz:null,hasQuiz:!1,isGeneratingQuiz:!1}}),s.confusingPoints&&s.confusingPoints.length>0&&s.confusingPoints.forEach((a,i)=>{const l=`step_${t.length}`;t.push({id:l,title:`易混淆點 ${i+1}`,type:"confusing",icon:"⚡",data:a,index:i}),n[l]={original:a,transformed:null,isTransformed:!1,isTransforming:!1,quiz:null,hasQuiz:!1,isGeneratingQuiz:!1}}),M(t),j(n)},oe=()=>localStorage.getItem("gemini_api_key")||"",ce=async s=>{const t=oe();if(!t){alert("請先設定 Gemini API 金鑰");return}const n=f.find(a=>a.id===s);if(n){j(a=>({...a,[s]:{...a[s],isTransforming:!0}}));try{let a=null;switch(n.type){case"objective":a=await ne(n.data,t);break;case"breakdown":a=await te(n.data,t);break;case"confusing":a=await se(n.data,t);break}j(i=>({...i,[s]:{...i[s],transformed:a,isTransformed:!0,isTransforming:!1}}))}catch(a){console.error("轉換失敗:",a),j(i=>({...i,[s]:{...i[s],isTransforming:!1}})),alert("轉換失敗，請重試")}}},ve=s=>{j(t=>({...t,[s]:{...t[s],transformed:null,isTransformed:!1,quiz:null,hasQuiz:!1}}))},Y=s=>{ue(s),H(!0)},Ne=async(s,t)=>{if(!oe()){alert("請先設定 Gemini API 金鑰");return}const a=parseInt(s.replace("step_","")),i=f[a],l=x[s];if(!i||!l?.isTransformed||!l.transformed){alert("請先轉換內容後再生成測驗");return}j(o=>({...o,[s]:{...o[s],isGeneratingQuiz:!0}}));try{const o=t||D,u=await Oe(l.transformed,i.type,o);j($=>({...$,[s]:{...$[s],quiz:u,hasQuiz:!0,isGeneratingQuiz:!1}})),H(!1)}catch(o){console.error("測驗生成失敗:",o),j(u=>({...u,[s]:{...u[s],isGeneratingQuiz:!1}})),alert("測驗生成失敗，請重試")}},ye=s=>{const t=x[s];t?.hasQuiz&&t.quiz&&(fe(t.quiz),be(s),K(!0))},we=s=>{j(t=>({...t,[s]:{...t[s],quiz:null,hasQuiz:!1}}))},ke=async()=>{if(!C)return;const s=localStorage.getItem("gemini_api_key");if(!s){alert("請先設定 Gemini API Key");return}P("running");const t=f.length;_({current:0,total:t});try{for(let n=0;n<f.length;n++){const a=f[n],i=`step_${n}`;if(_({current:n+1,total:t,currentStep:a.title}),!x[i]?.isTransformed){j(l=>({...l,[i]:{...l[i],isTransforming:!0}}));try{let l;switch(a.type){case"objective":l=await ne(a.data,s);break;case"breakdown":l=await te(a.data,s);break;case"confusing":l=await se(a.data,s);break}j(o=>({...o,[i]:{...o[i],transformed:l,isTransformed:!0,isTransforming:!1}}))}catch(l){console.error(`轉換步驟 ${a.title} 失敗:`,l),j(o=>({...o,[i]:{...o[i],isTransforming:!1}}))}await new Promise(l=>setTimeout(l,500))}}P("completed")}catch(n){console.error("批次轉換失敗:",n),P("error")}},Se=s=>{V(t=>{const n=new Set(t);return n.has(s)?n.delete(s):n.add(s),n})},Ce=()=>{const s=f.map((t,n)=>`step_${n}`);V(new Set(s))},ze=()=>{V(new Set)},Le=async()=>{if(!C||z.size===0){alert("請先選擇要轉換的步驟");return}const s=localStorage.getItem("gemini_api_key");if(!s){alert("請先設定 Gemini API Key");return}P("running");const t=z.size;_({current:0,total:t});try{let n=0;for(let a=0;a<f.length;a++){const i=f[a],l=`step_${a}`;if(z.has(l)&&(n++,_({current:n,total:t,currentStep:i.title}),!x[l]?.isTransformed)){j(o=>({...o,[l]:{...o[l],isTransforming:!0}}));try{let o;switch(i.type){case"objective":o=await ne(i.data,s);break;case"breakdown":o=await te(i.data,s);break;case"confusing":o=await se(i.data,s);break}j(u=>({...u,[l]:{...u[l],transformed:o,isTransformed:!0,isTransforming:!1}}))}catch(o){console.error(`轉換步驟 ${i.title} 失敗:`,o),j(u=>({...u,[l]:{...u[l],isTransforming:!1}}))}await new Promise(o=>setTimeout(o,500))}}P("completed")}catch(n){console.error("批次轉換失敗:",n),P("error")}},ee=async s=>{try{await L.init();const t=await L.getVersions(s);xe(t)}catch(t){console.error("載入現有版本失敗:",t)}},Te=async()=>{if(console.log("=== 開始保存版本 ==="),console.log("content:",!!C),console.log("contentId:",g),console.log("transformations:",x),!C){console.log("❌ 缺少 content"),alert("缺少教案內容，無法保存版本");return}const s=X();if(!s){console.log("❌ 無法取得有效的 contentId"),alert("無法識別當前教案，請重新進入頁面");return}console.log("使用的 contentId:",s);const t={},n={};if(Object.entries(x).forEach(([a,i])=>{console.log(`檢查步驟 ${a}:`,{isTransformed:i.isTransformed,hasTransformed:!!i.transformed,hasQuiz:i.hasQuiz,hasQuizData:!!i.quiz}),i.isTransformed&&i.transformed&&(t[a]=i.transformed),i.hasQuiz&&i.quiz&&(n[a]=i.quiz)}),console.log("收集到的資料:",{transformedDataCount:Object.keys(t).length,quizDataCount:Object.keys(n).length,selectedStepsCount:z.size}),Object.keys(t).length===0){console.log("❌ 沒有已轉換的內容"),alert("請先轉換一些內容再保存版本");return}try{console.log("初始化 interactiveContentStorage..."),await L.init(),console.log("✅ 初始化成功");const a=ie||`版本 ${new Date().toLocaleString("zh-TW")}`,i={transformedData:t,quizData:n};console.log("準備保存版本:",{actualContentId:s,topic:C.topic||"無標題教案",versionName:a,versionData:i,selectedSteps:Array.from(z)});const l=await L.saveVersion(s,C.topic||"無標題教案",i,Array.from(z),a,`包含 ${Object.keys(t).length} 個已轉換步驟，${Object.keys(n).length} 個測驗`);console.log("✅ 版本保存成功，ID:",l),le(""),await ee(s),alert("版本保存成功！")}catch(a){console.error("❌ 保存版本失敗:",a),console.error("錯誤堆棧:",a.stack),alert(`保存版本失敗：${a.message||a}`)}console.log("=== 保存版本結束 ===")},Pe=async s=>{const t=X();if(t)try{await L.init();const n=await L.getVersion(t,s);if(n){j({});const a={};f.forEach((o,u)=>{const $=`step_${u}`;a[$]={original:o.data,transformed:null,isTransformed:!1,isTransforming:!1,quiz:null,hasQuiz:!1,isGeneratingQuiz:!1}});const i=n.transformedData?.transformedData||n.transformedData,l=n.transformedData?.quizData||{};Object.entries(i||{}).forEach(([o,u])=>{a[o]&&(a[o]={...a[o],transformed:u,isTransformed:!0})}),Object.entries(l||{}).forEach(([o,u])=>{a[o]&&(a[o]={...a[o],quiz:u,hasQuiz:!0})}),j(a),V(new Set(n.selectedSteps)),ae(s),R(!1),await L.updateLastAccessed(t)}}catch(n){console.error("載入版本失敗:",n),alert("載入版本失敗，請重試")}},Qe=async s=>{const t=X();if(!t)return;const n=A.find(a=>a.id===s);if(n&&confirm(`確定要刪除版本「${n.name}」嗎？此操作無法復原。`))try{await L.init(),await L.deleteVersion(t,s),await ee(t),q===s&&ae(null)}catch(a){console.error("刪除版本失敗:",a),alert("刪除版本失敗，請重試")}},Ae=s=>s?[/#+\s/,/\*\*.*\*\*/,/\*.*\*/,/`.*`/,/^\s*[-*+]\s/m,/^\s*\d+\.\s/m,/\[.*\]\(.*\)/,/^\s*>/m,/```[\s\S]*?```/,/\n\s*\n/].some(n=>n.test(s)):!1,b=(s,t)=>Ae(s)?e.jsx(Ve,{content:s,className:t}):e.jsx("span",{className:t,children:s}),Ie=async()=>{if(C){r("publishing");try{const s={},t={},n={};if(Object.entries(x).forEach(([o,u])=>{if(u.isTransformed&&u.transformed){s[o]=u.transformed,u.hasQuiz&&u.quiz&&(t[o]=u.quiz);const $=parseInt(o.replace("step_","")),W=f[$];if(W)switch(W.type){case"objective":n.learningObjectives||(n.learningObjectives=[]),n.learningObjectives.push(W.data);break;case"breakdown":n.contentBreakdown||(n.contentBreakdown=[]),n.contentBreakdown.push(W.data);break;case"confusing":n.confusingPoints||(n.confusingPoints=[]),n.confusingPoints.push(W.data);break}}}),Object.keys(s).length===0){alert("請先轉換一些內容再發布"),r("idle");return}const a={...n,topic:C.topic,isInteractive:!0,transformedData:s,stepQuizData:t,includedSteps:Object.keys(s)},i=await Me(a),l=`${window.location.origin}/ai-page-gen/student-interactive?binId=${i}`;N(l),r("published")}catch(s){console.error("發布失敗:",s),r("error")}}},$e=s=>{T(s)},Fe=()=>{k<f.length-1&&T(k+1)},Be=()=>{k>0&&T(k-1)};if(E)return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-100 via-sky-50 to-indigo-100 py-8 px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"flex justify-center items-center min-h-[50vh]",children:e.jsx(_e,{})})});if(G)return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-100 via-sky-50 to-indigo-100 py-8 px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsxs("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-md",children:[e.jsx("h3",{className:"font-bold text-lg mb-2",children:"載入錯誤"}),e.jsx("p",{children:G})]})})});if(!C||f.length===0)return null;const m=f[k],De=`step_${k}`,h=x[De]||{transformed:null,isTransformed:!1},Z=Object.values(x).filter(s=>s.isTransformed).length,I=f.length;return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-100 via-sky-50 to-indigo-100",children:[e.jsx("div",{className:"sticky top-0 z-10 bg-white/90 backdrop-blur-sm border-b border-slate-200",children:e.jsxs("div",{className:"max-w-6xl mx-auto px-4 py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-slate-800",children:"互動教材準備"}),e.jsx("h2",{className:"text-lg font-semibold text-indigo-600",children:C.topic}),e.jsxs("p",{className:"text-sm text-slate-600",children:["第 ",k+1," 步，共 ",I," 步 • 已轉換：",Z,"/",I]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[p==="running"&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("svg",{className:"w-4 h-4 text-blue-600 animate-spin",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})}),e.jsx("span",{className:"text-blue-800 font-medium",children:"批次轉換進行中..."})]}),e.jsx("div",{className:"text-xs text-blue-700",children:O.currentStep&&`正在轉換：${O.currentStep}`}),e.jsx("div",{className:"mt-1 bg-blue-200 rounded-full h-1",children:e.jsx("div",{className:"bg-blue-600 h-1 rounded-full transition-all duration-300",style:{width:`${O.current/O.total*100}%`}})})]}),p==="completed"&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("svg",{className:"w-4 h-4 text-green-600",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5 13l4 4L19 7"})}),e.jsx("span",{className:"text-green-800 font-medium text-sm",children:"批次轉換完成！"})]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:Le,disabled:p==="running"||z.size===0,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-medium rounded-lg transition-colors flex items-center gap-2",children:p==="running"?e.jsxs(e.Fragment,{children:[e.jsx("svg",{className:"w-4 h-4 animate-spin",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})}),"轉換中..."]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M13 10V3L4 14h7v7l9-11h-7z"})}),"轉換選中項目 (",z.size,")"]})}),e.jsx("button",{onClick:ke,disabled:p==="running"||Z===I,className:"px-3 py-2 bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-medium rounded-lg transition-colors flex items-center gap-2 text-sm",children:Z===I?"全部已轉換":"全部轉換"})]}),B==="published"&&e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("svg",{className:"w-5 h-5 text-green-600",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5 13l4 4L19 7"})}),e.jsx("span",{className:"text-green-800 font-medium",children:"已發布成功！"})]}),e.jsx("div",{className:"text-xs text-green-700",children:e.jsx("a",{href:S,target:"_blank",rel:"noopener noreferrer",className:"underline hover:no-underline",children:"查看學生學習頁面"})})]}),e.jsx("button",{onClick:Ie,disabled:B==="publishing"||Z===0,className:"px-6 py-3 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-medium rounded-lg transition-colors flex items-center gap-2",children:B==="publishing"?e.jsxs(e.Fragment,{children:[e.jsx("svg",{className:"w-4 h-4 animate-spin",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})}),"發布中..."]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})}),"發布互動教材"]})})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"w-full bg-slate-200 rounded-full h-2",children:e.jsx("div",{className:"bg-gradient-to-r from-indigo-500 to-sky-500 h-2 rounded-full transition-all duration-500 ease-out",style:{width:`${(k+1)/I*100}%`}})}),e.jsxs("div",{className:"flex items-center gap-4 mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:Ce,className:"text-xs text-indigo-600 hover:text-indigo-800 font-medium",children:"全選"}),e.jsx("span",{className:"text-slate-300",children:"|"}),e.jsx("button",{onClick:ze,className:"text-xs text-slate-600 hover:text-slate-800 font-medium",children:"全不選"})]}),e.jsxs("div",{className:"text-xs text-slate-500",children:["已選擇 ",z.size," / ",f.length," 個步驟"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[A.length>0&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-slate-500",children:"版本:"}),e.jsx("button",{onClick:()=>R(!re),className:"text-indigo-600 hover:text-indigo-800 font-medium",children:q?A.find(s=>s.id===q)?.name||"選擇版本":`${A.length} 個可用`})]}),e.jsx("input",{type:"text",placeholder:"版本名稱",value:ie,onChange:s=>le(s.target.value),className:"px-2 py-1 text-xs border border-slate-300 rounded w-20"}),e.jsx("button",{onClick:()=>{console.log("🔴 保存版本按鈕被點擊了！"),Te()},className:"text-green-600 hover:text-green-800 font-medium",children:"保存版本"})]})]}),e.jsx("div",{className:"flex items-center gap-2 overflow-x-auto pb-1",children:f.map((s,t)=>{const n=`step_${t}`;return e.jsx("div",{className:`
                      flex-shrink-0 p-2 rounded-lg border transition-all duration-200 bg-white
                      ${t===k?"border-indigo-500 bg-indigo-50":x[n]?.isTransformed?"border-green-200 bg-green-50":"border-slate-200"}
                    `,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:z.has(n),onChange:()=>Se(n),className:"w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"}),e.jsxs("button",{onClick:()=>$e(t),className:"flex items-center gap-1 text-xs font-medium hover:text-indigo-600 transition-colors",children:[e.jsx("span",{children:s.icon}),e.jsx("span",{children:s.title}),x[n]?.isTransformed&&e.jsx("svg",{className:"w-3 h-3 text-green-600",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5 13l4 4L19 7"})})]}),x[n]?.isTransformed?e.jsxs("div",{className:"flex items-center gap-1 ml-2",children:[e.jsx("button",{onClick:()=>ce(n),className:"text-xs text-blue-600 hover:text-blue-800 font-medium px-1 py-0.5 rounded hover:bg-blue-50",title:"重新轉換",children:"🔄"}),e.jsx("button",{onClick:()=>ve(n),className:"text-xs text-red-600 hover:text-red-800 font-medium px-1 py-0.5 rounded hover:bg-red-50",title:"重置",children:"🗑️"}),x[n]?.hasQuiz?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-xs text-orange-600",title:"已生成測驗",children:"🧠"}),e.jsx("button",{onClick:()=>ye(n),className:"text-xs text-blue-600 hover:text-blue-800 font-medium px-1 py-0.5 rounded hover:bg-blue-50",title:"預覽測驗",children:"👁️"}),e.jsx("button",{onClick:()=>Y(n),disabled:x[n]?.isGeneratingQuiz,className:"text-xs text-orange-600 hover:text-orange-800 font-medium px-1 py-0.5 rounded hover:bg-orange-50",title:"重新生成測驗",children:x[n]?.isGeneratingQuiz?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-orange-600 rounded-full animate-pulse"}),e.jsx("span",{children:"生成中"})]}):"🔄"}),e.jsx("button",{onClick:()=>we(n),className:"text-xs text-red-600 hover:text-red-800 font-medium px-1 py-0.5 rounded hover:bg-red-50",title:"刪除測驗",children:"🗑️"})]}):e.jsx("button",{onClick:()=>Y(n),disabled:x[n]?.isGeneratingQuiz,className:"text-xs text-orange-600 hover:text-orange-800 font-medium px-1 py-0.5 rounded hover:bg-orange-50 disabled:opacity-50",title:"生成測驗",children:x[n]?.isGeneratingQuiz?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-orange-600 rounded-full animate-pulse"}),e.jsx("span",{className:"text-xs",children:"生成中"})]}):"🧠"})]}):e.jsx("button",{onClick:()=>ce(n),disabled:x[n]?.isTransforming,className:"text-xs text-green-600 hover:text-green-800 font-medium px-2 py-0.5 rounded hover:bg-green-50 disabled:opacity-50 ml-2",children:x[n]?.isTransforming?"⏳":"▶️"})]})},s.id)})}),re&&A.length>0&&e.jsxs("div",{className:"mt-4 p-4 bg-slate-50 rounded-lg border",children:[e.jsx("h3",{className:"text-sm font-medium text-slate-800 mb-3",children:"選擇版本載入"}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:A.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-white rounded border hover:bg-slate-50",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium",children:s.name}),q===s.id&&e.jsx("span",{className:"px-2 py-1 bg-indigo-100 text-indigo-800 text-xs rounded",children:"當前"})]}),e.jsxs("div",{className:"text-xs text-slate-500 mt-1",children:[s.description," • ",new Date(s.createdAt).toLocaleString("zh-TW")]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>Pe(s.id),className:"text-xs text-indigo-600 hover:text-indigo-800 font-medium",children:"載入"}),e.jsx("button",{onClick:()=>Qe(s.id),className:"text-xs text-red-600 hover:text-red-800 font-medium",children:"刪除"})]})]},s.id))}),e.jsx("button",{onClick:()=>R(!1),className:"mt-3 text-xs text-slate-600 hover:text-slate-800",children:"關閉"})]})]})]})}),e.jsxs("div",{className:"max-w-6xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"text-5xl mb-4",children:m.icon}),e.jsx("h2",{className:"text-3xl font-bold text-slate-800 mb-2",children:m.title}),e.jsxs("p",{className:"text-lg text-slate-600",children:[m.type==="objective"&&"將學習目標轉換為學生友好的語言",m.type==="breakdown"&&"將內容分解轉換為易懂的學習材料",m.type==="confusing"&&"將易混淆點轉換為支持性指導"]})]}),e.jsx("div",{className:"bg-white rounded-2xl shadow-lg p-6 mb-8",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"text-2xl",children:h.isTransformed?"✅":"🔄"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-slate-800",children:h.isTransformed?"已完成轉換":"準備轉換內容"}),e.jsx("p",{className:"text-sm text-slate-600",children:h.isTransformed?"內容已轉換為學生友好格式，可以進行預覽或重新轉換":"點擊轉換按鈕將教師導向內容轉換為學生友好格式"})]})]}),e.jsx("div",{className:"text-sm text-slate-500",children:"使用上方導航欄中的控制按鈕進行轉換操作"})]})}),e.jsxs("div",{className:"grid lg:grid-cols-2 gap-8 mb-8",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-6",children:[e.jsxs("h3",{className:"text-lg font-bold text-slate-800 mb-4 flex items-center gap-2",children:[e.jsx("span",{children:"📄"}),"原始內容（教師導向）"]}),e.jsxs("div",{className:"bg-slate-50 rounded-xl p-4 text-sm text-slate-700 max-h-96 overflow-y-auto",children:[m.type==="objective"&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"目標："})," ",b(m.data.objective)]}),m.data.description&&e.jsxs("div",{children:[e.jsx("strong",{children:"描述："})," ",b(m.data.description)]}),m.data.teachingExample&&e.jsxs("div",{children:[e.jsx("strong",{children:"教學範例："})," ",b(m.data.teachingExample)]})]}),m.type==="breakdown"&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"主題："})," ",b(m.data.topic)]}),m.data.details&&e.jsxs("div",{children:[e.jsx("strong",{children:"詳細說明："})," ",b(m.data.details)]}),m.data.teachingExample&&e.jsxs("div",{children:[e.jsx("strong",{children:"教學範例："})," ",b(m.data.teachingExample)]})]}),m.type==="confusing"&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"易混淆點："})," ",b(m.data.point)]}),m.data.clarification&&e.jsxs("div",{children:[e.jsx("strong",{children:"澄清說明："})," ",b(m.data.clarification)]}),m.data.teachingExample&&e.jsxs("div",{children:[e.jsx("strong",{children:"教學範例："})," ",b(m.data.teachingExample)]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-6",children:[e.jsxs("h3",{className:"text-lg font-bold text-slate-800 mb-4 flex items-center gap-2",children:[e.jsx("span",{children:"✨"}),"轉換後內容（學生友好）"]}),e.jsx("div",{className:"bg-gradient-to-br from-green-50 to-blue-50 rounded-xl p-4 text-sm max-h-96 overflow-y-auto",children:h.isTransformed&&h.transformed?e.jsxs("div",{className:"space-y-4",children:[m.type==="objective"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-green-800",children:[e.jsx("strong",{children:"學習目標："}),e.jsx("div",{className:"mt-1",children:b(h.transformed.objective)})]}),h.transformed.description&&e.jsxs("div",{className:"text-blue-800",children:[e.jsx("strong",{children:"為什麼要學："}),e.jsx("div",{className:"mt-1",children:b(h.transformed.description)})]}),h.transformed.personalRelevance&&e.jsxs("div",{className:"text-purple-800",children:[e.jsx("strong",{children:"對你的意義："}),e.jsx("div",{className:"mt-1",children:b(h.transformed.personalRelevance)})]}),h.transformed.encouragement&&e.jsxs("div",{className:"text-sky-800",children:[e.jsx("strong",{children:"給你的鼓勵："}),e.jsx("div",{className:"mt-1",children:b(h.transformed.encouragement)})]})]}),m.type==="breakdown"&&e.jsxs(e.Fragment,{children:[h.transformed.title&&e.jsxs("div",{className:"text-green-800",children:[e.jsx("strong",{children:"學習主題："}),e.jsx("div",{className:"mt-1",children:b(h.transformed.title)})]}),h.transformed.introduction&&e.jsxs("div",{className:"text-blue-800",children:[e.jsx("strong",{children:"開始學習："}),e.jsx("div",{className:"mt-1",children:b(h.transformed.introduction)})]}),h.transformed.keyPoints&&e.jsxs("div",{className:"text-indigo-800",children:[e.jsx("strong",{children:"重點概念："}),e.jsx("div",{className:"mt-1 space-y-1",children:h.transformed.keyPoints.map((s,t)=>e.jsxs("div",{children:["• ",b(s)]},t))})]})]}),m.type==="confusing"&&e.jsxs(e.Fragment,{children:[h.transformed.title&&e.jsxs("div",{className:"text-amber-800",children:[e.jsx("strong",{children:"容易困惑的地方："}),e.jsx("div",{className:"mt-1",children:b(h.transformed.title)})]}),h.transformed.normalizeConfusion&&e.jsxs("div",{className:"text-green-800",children:[e.jsx("strong",{children:"別擔心："}),e.jsx("div",{className:"mt-1",children:b(h.transformed.normalizeConfusion)})]}),h.transformed.clearExplanation&&e.jsxs("div",{className:"text-blue-800",children:[e.jsx("strong",{children:"正確理解："}),e.jsx("div",{className:"mt-1",children:b(h.transformed.clearExplanation)})]})]})]}):e.jsxs("div",{className:"text-slate-500 text-center py-8",children:[e.jsx("div",{className:"text-4xl mb-4",children:"🔄"}),e.jsx("p",{children:"使用上方導航欄中的 ▶️ 按鈕來生成學生友好的內容"})]})})]})]}),e.jsxs("div",{className:"flex items-center justify-between pt-8 border-t border-slate-200",children:[e.jsxs("button",{onClick:Be,disabled:k===0,className:"flex items-center gap-2 px-6 py-3 bg-slate-500 text-white font-medium rounded-lg hover:bg-slate-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15 19l-7-7 7-7"})}),"上一步"]}),e.jsx("div",{className:"text-center",children:e.jsxs("p",{className:"text-sm text-slate-600",children:[k+1," / ",I]})}),e.jsxs("button",{onClick:Fe,disabled:k===f.length-1,className:"flex items-center gap-2 px-6 py-3 bg-indigo-500 text-white font-medium rounded-lg hover:bg-indigo-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:["下一步",e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 5l7 7-7 7"})})]})]})]}),he&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-md w-full",children:[e.jsx("div",{className:"p-6 border-b",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xl font-bold text-slate-800",children:"測驗設定"}),e.jsx("button",{onClick:()=>H(!1),className:"p-1 hover:bg-slate-100 rounded-full",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18L18 6M6 6l12 12"})})})]})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"是非題數量"}),e.jsx("input",{type:"number",min:"1",max:"10",value:D.trueFalse,onChange:s=>J(t=>({...t,trueFalse:parseInt(s.target.value)||1})),className:"w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"選擇題數量"}),e.jsx("input",{type:"number",min:"1",max:"10",value:D.multipleChoice,onChange:s=>J(t=>({...t,multipleChoice:parseInt(s.target.value)||1})),className:"w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"記憶卡遊戲組數"}),e.jsx("input",{type:"number",min:"1",max:"3",value:D.memoryCardGame,onChange:s=>J(t=>({...t,memoryCardGame:parseInt(s.target.value)||1})),className:"w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"})]})]}),e.jsx("div",{className:"p-6 border-t bg-slate-50 rounded-b-2xl",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>H(!1),className:"flex-1 px-4 py-2 bg-slate-500 text-white font-medium rounded-lg hover:bg-slate-600 transition-colors",children:"取消"}),e.jsx("button",{onClick:()=>Ne(U,D),disabled:x[U]?.isGeneratingQuiz,className:"flex-1 px-4 py-2 bg-orange-500 text-white font-medium rounded-lg hover:bg-orange-600 transition-colors disabled:opacity-50",children:x[U]?.isGeneratingQuiz?e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"生成中..."]}):"生成測驗"})]})})]})}),ge&&y&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"sticky top-0 bg-white border-b p-6 flex items-center justify-between rounded-t-2xl",children:[e.jsx("h3",{className:"text-xl font-bold text-slate-800",children:"📝 測驗預覽"}),e.jsx("button",{onClick:()=>K(!1),className:"p-2 hover:bg-slate-100 rounded-full transition-colors",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"p-6 space-y-6",children:[y._validationWarnings&&y._validationWarnings.length>0&&e.jsx("div",{className:"bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("svg",{className:"h-5 w-5 text-yellow-400",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z"})})}),e.jsxs("div",{className:"ml-3",children:[e.jsx("h4",{className:"text-sm font-medium text-yellow-800",children:"⚠️ 發現記憶卡內容問題"}),e.jsxs("div",{className:"mt-2 text-sm text-yellow-700",children:[e.jsx("ul",{className:"list-disc list-inside space-y-1",children:y._validationWarnings.map((s,t)=>e.jsx("li",{children:s},t))}),e.jsx("p",{className:"mt-2 font-medium",children:"建議重新生成測驗以確保學生體驗良好！"})]})]})]})}),y.trueFalse&&y.trueFalse.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-lg font-semibold text-slate-700 mb-4 flex items-center gap-2",children:[e.jsx("span",{children:"✓"})," 是非判斷題 (",y.trueFalse.length," 題)"]}),e.jsx("div",{className:"space-y-3",children:y.trueFalse.map((s,t)=>e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"font-medium text-slate-800 mb-2",children:[t+1,". ",s.statement]}),e.jsxs("div",{className:"text-sm text-slate-600",children:[e.jsx("strong",{children:"答案："})," ",s.isTrue?"正確":"錯誤"]}),s.explanation&&e.jsxs("div",{className:"text-sm text-slate-600 mt-1",children:[e.jsx("strong",{children:"解釋："})," ",s.explanation]})]},t))})]}),y.multipleChoice&&y.multipleChoice.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-lg font-semibold text-slate-700 mb-4 flex items-center gap-2",children:[e.jsx("span",{children:"📝"})," 選擇題 (",y.multipleChoice.length," 題)"]}),e.jsx("div",{className:"space-y-3",children:y.multipleChoice.map((s,t)=>e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"font-medium text-slate-800 mb-2",children:[t+1,". ",s.question]}),e.jsx("div",{className:"ml-4 space-y-1",children:s.options.map((n,a)=>e.jsxs("div",{className:`text-sm ${a===s.correctAnswerIndex?"text-green-700 font-medium":"text-slate-600"}`,children:[String.fromCharCode(65+a),". ",n,a===s.correctAnswerIndex&&" ✓"]},a))}),s.explanation&&e.jsxs("div",{className:"text-sm text-slate-600 mt-2",children:[e.jsx("strong",{children:"解釋："})," ",s.explanation]})]},t))})]}),y.memoryCardGame&&y.memoryCardGame.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-lg font-semibold text-slate-700 mb-4 flex items-center gap-2",children:[e.jsx("span",{children:"🧠"})," 記憶卡配對 (",y.memoryCardGame.length," 組)"]}),e.jsx("div",{className:"space-y-3",children:y.memoryCardGame.map((s,t)=>e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"font-medium text-slate-800 mb-3",children:["第 ",t+1," 組：",s.title||"配對遊戲"]}),e.jsx("div",{className:"grid md:grid-cols-2 gap-2",children:s.pairs.map((n,a)=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("div",{className:"bg-blue-100 px-2 py-1 rounded flex-1",children:n.left}),e.jsx("div",{className:"text-slate-400",children:"⟷"}),e.jsx("div",{className:"bg-green-100 px-2 py-1 rounded flex-1",children:n.right})]},a))})]},t))})]})]}),e.jsx("div",{className:"sticky bottom-0 bg-slate-50 p-6 border-t rounded-b-2xl",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>K(!1),className:"flex-1 px-4 py-2 bg-slate-500 text-white font-medium rounded-lg hover:bg-slate-600 transition-colors",children:"關閉預覽"}),e.jsx("button",{onClick:()=>{K(!1),Y(je)},className:"flex-1 px-4 py-2 bg-orange-500 text-white font-medium rounded-lg hover:bg-orange-600 transition-colors",children:"重新生成"})]})})]})})]})};export{Ue as T,Re as W};
