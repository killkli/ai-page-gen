<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦åŠ å¯†åˆ†äº«åŠŸèƒ½</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; }
        textarea { width: 100%; height: 100px; margin: 10px 0; }
        input { width: 300px; padding: 5px; margin: 5px; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ” Provider é…ç½®åŠ å¯†åˆ†äº«åŠŸèƒ½æ¸¬è©¦</h1>

    <div class="test-section info">
        <h2>æ¸¬è©¦èªªæ˜</h2>
        <p>é€™å€‹é é¢ç”¨æ–¼æ¸¬è©¦æ–°çš„åŠ å¯†åˆ†äº«åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š</p>
        <ul>
            <li>Provider é…ç½®çš„åŠ å¯†å’Œè§£å¯†</li>
            <li>å¯†ç¢¼å¼·åº¦é©—è­‰</li>
            <li>åˆ†äº« URL ç”Ÿæˆå’Œè§£æ</li>
            <li>æ•¸æ“šå®Œæ•´æ€§æª¢æŸ¥</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>1. åŠ å¯†/è§£å¯†æ¸¬è©¦</h2>
        <div>
            <label>æ¸¬è©¦æ•¸æ“š:</label>
            <textarea id="testData">{
  "providers": [
    {
      "type": "gemini",
      "name": "æ¸¬è©¦ Gemini",
      "model": "gemini-2.5-flash",
      "apiKey": "test-api-key-123",
      "settings": { "temperature": 0.7 }
    }
  ],
  "sharedAt": "2025-09-21T12:00:00.000Z"
}</textarea>
        </div>
        <div>
            <label>å¯†ç¢¼:</label>
            <input type="password" id="testPassword" value="TestPassword123!" placeholder="è¼¸å…¥æ¸¬è©¦å¯†ç¢¼">
            <button onclick="generateRandomPassword()">ç”Ÿæˆéš¨æ©Ÿå¯†ç¢¼</button>
        </div>
        <div>
            <button onclick="testEncryption()">æ¸¬è©¦åŠ å¯†</button>
            <button onclick="testDecryption()">æ¸¬è©¦è§£å¯†</button>
            <button onclick="testPasswordStrength()">æª¢æŸ¥å¯†ç¢¼å¼·åº¦</button>
        </div>
        <div id="encryptionResult"></div>
    </div>

    <div class="test-section">
        <h2>2. åˆ†äº« URL æ¸¬è©¦</h2>
        <div>
            <label>æ¸¬è©¦ Bin ID:</label>
            <input type="text" id="testBinId" value="test-bin-12345" placeholder="è¼¸å…¥æ¸¬è©¦ Bin ID">
        </div>
        <div>
            <button onclick="testUrlGeneration()">ç”Ÿæˆåˆ†äº« URL</button>
            <button onclick="testUrlParsing()">è§£æç•¶å‰ URL</button>
        </div>
        <div id="urlResult"></div>
    </div>

    <div class="test-section">
        <h2>3. æ¨¡æ“¬åˆ†äº«æµç¨‹</h2>
        <div>
            <button onclick="simulateShareFlow()">æ¨¡æ“¬å®Œæ•´åˆ†äº«æµç¨‹</button>
        </div>
        <div id="simulationResult"></div>
    </div>

    <script type="module">
        // å°å…¥åŠ å¯†æœå‹™ï¼ˆéœ€è¦é©é…ç€è¦½å™¨ç’°å¢ƒï¼‰

        // ç°¡åŒ–ç‰ˆåŠ å¯†æœå‹™ç”¨æ–¼æ¸¬è©¦
        class TestEncryptionService {
            static async encrypt(data, password) {
                try {
                    const salt = crypto.getRandomValues(new Uint8Array(16));
                    const keyMaterial = await crypto.subtle.importKey(
                        'raw',
                        new TextEncoder().encode(password),
                        { name: 'PBKDF2' },
                        false,
                        ['deriveKey']
                    );

                    const key = await crypto.subtle.deriveKey(
                        {
                            name: 'PBKDF2',
                            salt: salt,
                            iterations: 100000,
                            hash: 'SHA-256'
                        },
                        keyMaterial,
                        { name: 'AES-GCM', length: 256 },
                        false,
                        ['encrypt']
                    );

                    const iv = crypto.getRandomValues(new Uint8Array(12));
                    const encrypted = await crypto.subtle.encrypt(
                        { name: 'AES-GCM', iv: iv },
                        key,
                        new TextEncoder().encode(data)
                    );

                    const combined = new Uint8Array(salt.length + iv.length + encrypted.byteLength);
                    combined.set(salt, 0);
                    combined.set(iv, salt.length);
                    combined.set(new Uint8Array(encrypted), salt.length + iv.length);

                    return btoa(String.fromCharCode(...combined));
                } catch (error) {
                    throw new Error('åŠ å¯†å¤±æ•—: ' + error.message);
                }
            }

            static async decrypt(encryptedData, password) {
                try {
                    const combined = new Uint8Array(
                        atob(encryptedData).split('').map(char => char.charCodeAt(0))
                    );

                    const salt = combined.slice(0, 16);
                    const iv = combined.slice(16, 28);
                    const encrypted = combined.slice(28);

                    const keyMaterial = await crypto.subtle.importKey(
                        'raw',
                        new TextEncoder().encode(password),
                        { name: 'PBKDF2' },
                        false,
                        ['deriveKey']
                    );

                    const key = await crypto.subtle.deriveKey(
                        {
                            name: 'PBKDF2',
                            salt: salt,
                            iterations: 100000,
                            hash: 'SHA-256'
                        },
                        keyMaterial,
                        { name: 'AES-GCM', length: 256 },
                        false,
                        ['decrypt']
                    );

                    const decrypted = await crypto.subtle.decrypt(
                        { name: 'AES-GCM', iv: iv },
                        key,
                        encrypted
                    );

                    return new TextDecoder().decode(decrypted);
                } catch (error) {
                    throw new Error('è§£å¯†å¤±æ•—: ' + error.message);
                }
            }

            static generateRandomPassword() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
                let result = '';
                for (let i = 0; i < 16; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            }

            static validatePasswordStrength(password) {
                const feedback = [];
                let score = 0;

                if (password.length < 8) {
                    feedback.push('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 8 å€‹å­—ç¬¦');
                } else {
                    score += 1;
                }

                if (!/[a-z]/.test(password)) {
                    feedback.push('éœ€è¦åŒ…å«å°å¯«å­—æ¯');
                } else {
                    score += 1;
                }

                if (!/[A-Z]/.test(password)) {
                    feedback.push('éœ€è¦åŒ…å«å¤§å¯«å­—æ¯');
                } else {
                    score += 1;
                }

                if (!/[0-9]/.test(password)) {
                    feedback.push('éœ€è¦åŒ…å«æ•¸å­—');
                } else {
                    score += 1;
                }

                if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
                    feedback.push('å»ºè­°åŒ…å«ç‰¹æ®Šå­—ç¬¦');
                } else {
                    score += 1;
                }

                return {
                    isValid: score >= 3,
                    score,
                    feedback
                };
            }
        }

        // å…¨å±€è®Šæ•¸ç”¨æ–¼æ¸¬è©¦
        let encryptedTestData = null;

        // æ¸¬è©¦å‡½æ•¸
        window.testEncryption = async function() {
            try {
                const data = document.getElementById('testData').value;
                const password = document.getElementById('testPassword').value;

                if (!password) {
                    throw new Error('è«‹è¼¸å…¥å¯†ç¢¼');
                }

                const encrypted = await TestEncryptionService.encrypt(data, password);
                encryptedTestData = encrypted;

                document.getElementById('encryptionResult').innerHTML = `
                    <div class="success">
                        <h3>âœ… åŠ å¯†æˆåŠŸ</h3>
                        <p><strong>åŸå§‹æ•¸æ“šé•·åº¦:</strong> ${data.length} å­—ç¬¦</p>
                        <p><strong>åŠ å¯†å¾Œé•·åº¦:</strong> ${encrypted.length} å­—ç¬¦</p>
                        <p><strong>åŠ å¯†æ•¸æ“šé è¦½:</strong></p>
                        <pre>${encrypted.substring(0, 100)}${encrypted.length > 100 ? '...' : ''}</pre>
                    </div>
                `;
            } catch (error) {
                document.getElementById('encryptionResult').innerHTML = `
                    <div class="error">
                        <h3>âŒ åŠ å¯†å¤±æ•—</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        };

        window.testDecryption = async function() {
            try {
                if (!encryptedTestData) {
                    throw new Error('è«‹å…ˆåŸ·è¡ŒåŠ å¯†æ¸¬è©¦');
                }

                const password = document.getElementById('testPassword').value;
                const decrypted = await TestEncryptionService.decrypt(encryptedTestData, password);

                document.getElementById('encryptionResult').innerHTML = `
                    <div class="success">
                        <h3>âœ… è§£å¯†æˆåŠŸ</h3>
                        <p><strong>è§£å¯†å¾Œæ•¸æ“š:</strong></p>
                        <pre>${decrypted}</pre>
                        <p><strong>æ•¸æ“šå®Œæ•´æ€§:</strong> ${decrypted === document.getElementById('testData').value ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´'}</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('encryptionResult').innerHTML = `
                    <div class="error">
                        <h3>âŒ è§£å¯†å¤±æ•—</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        };

        window.testPasswordStrength = function() {
            const password = document.getElementById('testPassword').value;
            const result = TestEncryptionService.validatePasswordStrength(password);

            const strengthLabel = result.score >= 4 ? 'å¼·' : result.score >= 3 ? 'ä¸­' : 'å¼±';
            const strengthColor = result.score >= 4 ? 'green' : result.score >= 3 ? 'orange' : 'red';

            document.getElementById('encryptionResult').innerHTML = `
                <div class="${result.isValid ? 'success' : 'error'}">
                    <h3>ğŸ”’ å¯†ç¢¼å¼·åº¦æª¢æ¸¬</h3>
                    <p><strong>å¯†ç¢¼:</strong> ${password}</p>
                    <p><strong>å¼·åº¦:</strong> <span style="color: ${strengthColor}; font-weight: bold;">${strengthLabel} (${result.score}/5)</span></p>
                    <p><strong>æœ‰æ•ˆæ€§:</strong> ${result.isValid ? 'âœ… æœ‰æ•ˆ' : 'âŒ ç„¡æ•ˆ'}</p>
                    ${result.feedback.length > 0 ? `
                        <p><strong>å»ºè­°:</strong></p>
                        <ul>${result.feedback.map(f => `<li>${f}</li>`).join('')}</ul>
                    ` : ''}
                </div>
            `;
        };

        window.generateRandomPassword = function() {
            const password = TestEncryptionService.generateRandomPassword();
            document.getElementById('testPassword').value = password;
        };

        window.testUrlGeneration = function() {
            const binId = document.getElementById('testBinId').value;
            const baseUrl = window.location.origin + window.location.pathname.replace('test-encryption.html', '');
            const shareUrl = `${baseUrl}?provider_share=${encodeURIComponent(binId)}`;

            document.getElementById('urlResult').innerHTML = `
                <div class="success">
                    <h3>âœ… åˆ†äº« URL ç”ŸæˆæˆåŠŸ</h3>
                    <p><strong>Bin ID:</strong> ${binId}</p>
                    <p><strong>åˆ†äº« URL:</strong></p>
                    <pre>${shareUrl}</pre>
                    <button onclick="navigator.clipboard.writeText('${shareUrl}')">è¤‡è£½ URL</button>
                </div>
            `;
        };

        window.testUrlParsing = function() {
            const params = new URLSearchParams(window.location.search);
            const providerShare = params.get('provider_share');
            const legacyApiKey = params.get('apikey');

            let result = '';
            if (providerShare) {
                result = `
                    <div class="success">
                        <h3>âœ… æª¢æ¸¬åˆ° Provider åˆ†äº«</h3>
                        <p><strong>é¡å‹:</strong> åŠ å¯† Provider é…ç½®åˆ†äº«</p>
                        <p><strong>Bin ID:</strong> ${providerShare}</p>
                    </div>
                `;
            } else if (legacyApiKey) {
                result = `
                    <div class="info">
                        <h3>â„¹ï¸ æª¢æ¸¬åˆ°èˆŠç‰ˆåˆ†äº«</h3>
                        <p><strong>é¡å‹:</strong> API Key åˆ†äº«</p>
                        <p><strong>API Key:</strong> ${legacyApiKey.substring(0, 10)}...</p>
                    </div>
                `;
            } else {
                result = `
                    <div class="info">
                        <h3>â„¹ï¸ æœªæª¢æ¸¬åˆ°åˆ†äº«åƒæ•¸</h3>
                        <p>ç•¶å‰ URL ä¸åŒ…å«åˆ†äº«åƒæ•¸</p>
                        <p>å¯ä»¥åœ¨ URL å¾Œæ·»åŠ  ?provider_share=test-id ä¾†æ¸¬è©¦</p>
                    </div>
                `;
            }

            document.getElementById('urlResult').innerHTML = result;
        };

        window.simulateShareFlow = async function() {
            try {
                document.getElementById('simulationResult').innerHTML = `
                    <div class="info">
                        <h3>ğŸ”„ æ­£åœ¨æ¨¡æ“¬åˆ†äº«æµç¨‹...</h3>
                    </div>
                `;

                // 1. æº–å‚™æ¸¬è©¦æ•¸æ“š
                const testData = document.getElementById('testData').value;
                const password = document.getElementById('testPassword').value || 'TestPassword123!';

                // 2. åŠ å¯†æ•¸æ“š
                const encrypted = await TestEncryptionService.encrypt(testData, password);

                // 3. æ¨¡æ“¬ä¸Šå‚³åˆ° JSONBinï¼ˆå¯¦éš›ä¸Šåªæ˜¯æœ¬åœ°å­˜å„²ï¼‰
                const mockBinId = 'mock_' + Date.now();
                const encryptedShare = {
                    id: mockBinId,
                    name: 'æ¸¬è©¦åˆ†äº«é…ç½®',
                    description: 'é€™æ˜¯ä¸€å€‹æ¸¬è©¦çš„ Provider é…ç½®åˆ†äº«',
                    encryptedData: encrypted,
                    metadata: {
                        version: '1.0',
                        createdAt: new Date().toISOString(),
                        providerTypes: ['gemini'],
                        providerCount: 1,
                        hasEncryption: true
                    }
                };

                // 4. ç”Ÿæˆåˆ†äº« URL
                const baseUrl = window.location.origin + window.location.pathname.replace('test-encryption.html', '');
                const shareUrl = `${baseUrl}?provider_share=${encodeURIComponent(mockBinId)}`;

                // 5. æ¨¡æ“¬æ¥æ”¶æ–¹è§£å¯†
                const decrypted = await TestEncryptionService.decrypt(encrypted, password);
                const isValid = decrypted === testData;

                document.getElementById('simulationResult').innerHTML = `
                    <div class="success">
                        <h3>âœ… å®Œæ•´åˆ†äº«æµç¨‹æ¨¡æ“¬æˆåŠŸ</h3>

                        <h4>1ï¸âƒ£ åˆ†äº«æ–¹ - å‰µå»ºåˆ†äº«</h4>
                        <p><strong>åŸå§‹æ•¸æ“š:</strong> ${testData.length} å­—ç¬¦</p>
                        <p><strong>åŠ å¯†å¯†ç¢¼:</strong> ${password}</p>
                        <p><strong>åŠ å¯†çµæœ:</strong> ${encrypted.length} å­—ç¬¦</p>

                        <h4>2ï¸âƒ£ ç³»çµ± - ç”Ÿæˆåˆ†äº«</h4>
                        <p><strong>Bin ID:</strong> ${mockBinId}</p>
                        <p><strong>åˆ†äº« URL:</strong></p>
                        <pre>${shareUrl}</pre>

                        <h4>3ï¸âƒ£ æ¥æ”¶æ–¹ - è§£å¯†é©—è­‰</h4>
                        <p><strong>è§£å¯†ç‹€æ…‹:</strong> ${isValid ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}</p>
                        <p><strong>æ•¸æ“šå®Œæ•´æ€§:</strong> ${isValid ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´'}</p>

                        <h4>4ï¸âƒ£ å®‰å…¨æ€§è©•ä¼°</h4>
                        <ul>
                            <li>âœ… ä½¿ç”¨ AES-GCM 256 ä½åŠ å¯†</li>
                            <li>âœ… PBKDF2 å¯†é‘°æ´¾ç”Ÿï¼ˆ100,000 æ¬¡è¿­ä»£ï¼‰</li>
                            <li>âœ… éš¨æ©Ÿé¹½å€¼å’Œåˆå§‹å‘é‡</li>
                            <li>âœ… å¯†ç¢¼å¼·åº¦é©—è­‰</li>
                            <li>âœ… æ•¸æ“šå®Œæ•´æ€§æª¢æŸ¥</li>
                        </ul>
                    </div>
                `;
            } catch (error) {
                document.getElementById('simulationResult').innerHTML = `
                    <div class="error">
                        <h3>âŒ åˆ†äº«æµç¨‹æ¨¡æ“¬å¤±æ•—</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        };

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ” Provider é…ç½®åŠ å¯†åˆ†äº«åŠŸèƒ½æ¸¬è©¦é é¢å·²è¼‰å…¥');

            // è‡ªå‹•æª¢æŸ¥ URL åƒæ•¸
            testUrlParsing();
        });
    </script>
</body>
</html>